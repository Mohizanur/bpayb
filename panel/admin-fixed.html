<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BirrPay Admin Panel</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #e2e8f0; }
        .container { display: flex; min-height: 100vh; }
        .sidebar { 
            width: 280px; 
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); 
            padding: 25px; 
            border-right: 1px solid #334155; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.3); 
            position: fixed; 
            top: 0; 
            left: 0; 
            height: 100vh; 
            overflow-y: auto; 
            z-index: 100; 
        }
        .main-content { 
            flex: 1; 
            padding: 25px; 
            background: rgba(15, 23, 42, 0.8); 
            margin-left: 280px; 
            min-height: 100vh; 
        }
        .logo { text-align: center; margin-bottom: 35px; }
        .logo h1 { color: #3b82f6; font-size: 1.8rem; font-weight: 800; margin-bottom: 5px; }
        .logo p { color: #64748b; font-size: 0.85rem; }
        .nav-item { padding: 15px 18px; margin: 10px 0; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 15px; position: relative; }
        .nav-item:hover { background: rgba(59, 130, 246, 0.1); transform: translateX(5px); }
        .nav-item.active { background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); color: white; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }
        .nav-item i { width: 20px; text-align: center; }
        .nav-count { background: rgba(59, 130, 246, 0.2); color: #3b82f6; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-left: auto; }
        .nav-item.active .nav-count { background: rgba(255,255,255,0.2); color: white; }
        .logout-item:hover { background: rgba(239, 68, 68, 0.1) !important; color: #ef4444 !important; }
        .logout-item:hover i { color: #ef4444; }
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            padding: 25px 30px; 
            background: rgba(30, 41, 59, 0.6); 
            border-radius: 15px; 
            backdrop-filter: blur(10px); 
            min-height: 80px;
        }
        .header h2 { 
            font-size: 1.8rem; 
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            margin: 0;
            flex: 1;
        }
        .header-actions { 
            display: flex; 
            gap: 20px; 
            align-items: center;
            margin-left: 30px;
        }
        .btn { padding: 12px 24px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3); }
        .btn-secondary { background: rgba(30, 41, 59, 0.8); color: #e2e8f0; border: 1px solid #334155; }
        .btn-secondary:hover { background: rgba(51, 65, 85, 0.8); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 15px; padding: 20px; text-align: center; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .stat-card:hover { transform: translateY(-5px); border-color: rgba(59, 130, 246, 0.4); box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899); }
        .stat-icon { display: inline-flex; align-items: center; justify-content: center; width: 55px; height: 55px; border-radius: 15px; margin-bottom: 12px; font-size: 1.5rem; color: white; }
        .stat-icon.users { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
        .stat-icon.subscriptions { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .stat-icon.revenue { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .stat-value { font-size: 2.2rem; font-weight: 900; margin: 10px 0; background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-label { color: #94a3b8; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-change { font-size: 0.75rem; margin-top: 6px; padding: 3px 6px; border-radius: 5px; }
        .stat-change.positive { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .stat-change.negative { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        
        /* Plan Pricing Styles */
        .plan-pricing { display: flex; flex-wrap: wrap; gap: 8px; }
        .plan-item { 
            background: rgba(59, 130, 246, 0.1); 
            border: 1px solid rgba(59, 130, 246, 0.2); 
            border-radius: 6px; 
            padding: 4px 8px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-width: 60px; 
        }
        .plan-duration { font-weight: 600; color: #3b82f6; font-size: 0.85rem; }
        .plan-price { color: #e2e8f0; font-weight: 500; font-size: 0.8rem; }
        .plan-type { color: #94a3b8; font-size: 0.7rem; text-transform: capitalize; }
        
        /* Service Info Styles */
        .service-info strong { color: #e2e8f0; }
        .service-meta { margin-top: 4px; }
        .service-meta small { color: #94a3b8; }
        
        /* Action Buttons */
        .action-buttons { display: flex; gap: 8px; }
        .action-buttons .btn { padding: 6px 12px; font-size: 0.85rem; }
        
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .table-container { background: rgba(30, 41, 59, 0.8); border-radius: 15px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.2); backdrop-filter: blur(10px); }
        .table-header { padding: 25px 30px; background: rgba(51, 65, 85, 0.8); border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; gap: 20px; }
        .table-title { font-size: 1.2rem; font-weight: 700; color: #e2e8f0; margin-right: 15px; }
        .table-actions { display: flex; gap: 15px; align-items: center; margin-left: auto; }
        .search-box { padding: 8px 15px; border: 1px solid #334155; border-radius: 8px; background: rgba(15, 23, 42, 0.8); color: #e2e8f0; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 18px 25px; text-align: left; border-bottom: 1px solid rgba(51, 65, 85, 0.5); }
        th { background: rgba(51, 65, 85, 0.6); font-weight: 700; color: #f1f5f9; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.5px; padding: 20px 25px; }
        tr:hover { background: rgba(59, 130, 246, 0.05); }
        .status { padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; }
        .status.active { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }
        .status.inactive { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
        .status.pending { background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3); }
        .action-btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin: 0 2px; }
        .action-btn.delete { background-color: #f44336; }
        .action-btn.delete:hover { background-color: #d32f2f; }
        .action-btn.ban { background-color: #ff9800; }
        .action-btn.ban:hover { background-color: #f57c00; }
        .action-btn.unban { background-color: #4caf50; }
        .action-btn.unban:hover { background-color: #388e3c; }
        .notification { position: fixed; top: 25px; right: 25px; padding: 18px 25px; border-radius: 12px; color: white; z-index: 10000; font-weight: 600; box-shadow: 0 10px 25px rgba(0,0,0,0.3); backdrop-filter: blur(10px); }
        .notification.success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .notification.error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .notification.info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 25px; margin-top: 30px; max-width: 1200px; }
        .chart-container { background: rgba(30, 41, 59, 0.8); border-radius: 15px; padding: 25px; border: 1px solid rgba(59, 130, 246, 0.2); height: 350px; position: relative; }
        .chart-title { font-size: 1.1rem; font-weight: 700; color: #e2e8f0; margin-bottom: 20px; text-align: center; }
        .chart-wrapper { position: relative; height: 280px; width: 100%; }
        .loading { display: flex; justify-content: center; align-items: center; padding: 40px; color: #64748b; }
        .loading i { animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 60px 20px; color: #64748b; }
        .empty-state i { font-size: 3rem; margin-bottom: 15px; opacity: 0.5; }
        .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 25px; }
        .pagination button { padding: 8px 12px; border: 1px solid #334155; background: rgba(30, 41, 59, 0.8); color: #e2e8f0; border-radius: 6px; cursor: pointer; }
        .pagination button.active { background: #3b82f6; border-color: #3b82f6; }
        .filters { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-select { padding: 8px 15px; border: 1px solid #334155; border-radius: 8px; background: rgba(15, 23, 42, 0.8); color: #e2e8f0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <h1><i class="fas fa-chart-line"></i> BirrPay</h1>
                <p>Admin Dashboard</p>
            </div>
            <div class="nav-item active" onclick="showTab('dashboard')">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </div>
            <div class="nav-item" onclick="showTab('users')">
                <i class="fas fa-users"></i> Users
                <span class="nav-count" id="users-count">0</span>
            </div>
            <div class="nav-item" onclick="showTab('subscriptions')">
                <i class="fas fa-credit-card"></i> Subscriptions
                <span class="nav-count" id="subscriptions-count">0</span>
            </div>
            <div class="nav-item" onclick="showTab('payments')">
                <i class="fas fa-money-bill"></i> Payments
                <span class="nav-count" id="payments-count">0</span>
            </div>
            <div class="nav-item" onclick="showTab('services')">
                <i class="fas fa-cogs"></i> Services
                <span class="nav-count" id="services-count">0</span>
            </div>
            <div class="nav-item logout-item" onclick="logout()" style="margin-top: 30px; border-top: 1px solid #334155; padding-top: 20px;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </div>
        </div>

        <div class="main-content">

            <div id="dashboard-tab" class="tab-content active">
                <div class="header">
                    <h2><i class="fas fa-chart-line"></i> Dashboard Overview</h2>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="configureToken()"><i class="fas fa-key"></i> Set Token</button>
                        <button class="btn btn-primary" onclick="exportData('users')"><i class="fas fa-download"></i> Export CSV</button>
                        <button class="btn btn-primary" onclick="manualRefresh()"><i class="fas fa-sync-alt"></i> Refresh</button>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon users"><i class="fas fa-users"></i></div>
                        <div class="stat-value" id="total-users">0</div>
                        <div class="stat-label">Total Users</div>
                        <div class="stat-change positive" id="users-change">+0% from last month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon subscriptions"><i class="fas fa-credit-card"></i></div>
                        <div class="stat-value" id="active-subscriptions">0</div>
                        <div class="stat-label">Active Subscriptions</div>
                        <div class="stat-change positive" id="subs-change">+0% from last month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon revenue"><i class="fas fa-coins"></i></div>
                        <div class="stat-value" id="total-revenue">ETB 0</div>
                        <div class="stat-label">Total Revenue</div>
                        <div class="stat-change positive" id="revenue-change">+0% from last month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon support"><i class="fas fa-headset"></i></div>
                        <div class="stat-value" id="open-tickets">0</div>
                        <div class="stat-label">Support Tickets</div>
                        <div class="stat-change negative" id="tickets-change">0 pending</div>
                    </div>
                </div>
                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-title">Revenue Trend</div>
                        <div class="chart-wrapper">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">User Growth</div>
                        <div class="chart-wrapper">
                            <canvas id="usersChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="users-tab" class="tab-content">
                <div class="header">
                    <h2><i class="fas fa-users"></i> Users Management</h2>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="exportData('users')"><i class="fas fa-download"></i> Export</button>
                        <button class="btn btn-primary" onclick="manualRefreshTab('users')"><i class="fas fa-sync-alt"></i> Refresh</button>
                    </div>
                </div>
                <div class="filters">
                    <select class="filter-select" onchange="filterUsers(this.value)">
                        <option value="all">All Users</option>
                        <option value="active">Active Only</option>
                        <option value="inactive">Inactive Only</option>
                    </select>
                    <input type="text" class="search-box" placeholder="Search users..." onkeyup="searchUsers(this.value)">
                </div>
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">User List</div>
                        <div class="table-actions">
                            <span id="users-total">0 users</span>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr><th>ID</th><th>Username</th><th>Name</th><th>Email</th><th>Status</th><th>Created</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr><td colspan="7" class="loading"><i class="fas fa-spinner"></i> Loading users...</td></tr>
                        </tbody>
                    </table>
                    <div class="pagination" id="users-pagination"></div>
                </div>
            </div>

            <div id="subscriptions-tab" class="tab-content">
                <div class="header">
                    <h2><i class="fas fa-credit-card"></i> Subscriptions Management</h2>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="exportData('subscriptions')"><i class="fas fa-download"></i> Export</button>
                        <button class="btn btn-primary" onclick="showTab('subscriptions')"><i class="fas fa-sync-alt"></i> Refresh</button>
                    </div>
                </div>
                <div class="filters">
                    <select class="filter-select" onchange="filterSubscriptions(this.value)">
                        <option value="all">All Subscriptions</option>
                        <option value="active">Active Only</option>
                        <option value="inactive">Inactive Only</option>
                        <option value="pending">Pending Only</option>
                    </select>
                    <select class="filter-select" onchange="filterByService(this.value)">
                        <option value="all">All Services</option>
                        <option value="netflix">Netflix</option>
                        <option value="spotify">Spotify</option>
                        <option value="youtube">YouTube Premium</option>
                    </select>
                </div>
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Subscription List</div>
                        <div class="table-actions">
                            <span id="subscriptions-total">0 subscriptions</span>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr><th>User Name</th><th>Service</th><th>Status</th><th>Amount</th><th>Created</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="subscriptions-table-body">
                            <tr><td colspan="6" class="loading"><i class="fas fa-spinner"></i> Loading subscriptions...</td></tr>
                        </tbody>
                    </table>
                    <div class="pagination" id="subscriptions-pagination"></div>
                </div>
            </div>

            <div id="payments-tab" class="tab-content">
                <h2>Payments Management</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>User Name</th><th>Amount</th><th>Status</th><th>Method</th><th>Created</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="payments-table-body">
                            <tr><td colspan="6" style="text-align: center; padding: 20px;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="support-tab" class="tab-content">
                <h2>Support Management</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>User Name</th><th>Subject</th><th>Status</th><th>Priority</th><th>Created</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="support-table-body">
                            <tr><td colspan="6" style="text-align: center; padding: 20px;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="services-tab" class="tab-content">
                <div id="services-content">
                    <div class="empty-state">
                        <i class="fas fa-cogs fa-3x"></i>
                        <h3>Loading Services...</h3>
                        <p>Please wait while we fetch service data.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // --- Admin Token Management & Fetch Interceptor ---
        (function () {
            const TOKEN_STORAGE_KEY = 'adminToken';

            window.getAdminToken = function () {
                const urlParam = new URLSearchParams(location.search).get('token');
                if (urlParam) {
                    localStorage.setItem(TOKEN_STORAGE_KEY, urlParam);
                    try { history.replaceState({}, '', location.pathname); } catch (_) {}
                    return urlParam;
                }
                
                const storedToken = localStorage.getItem(TOKEN_STORAGE_KEY);
                
                // Check if token is valid (basic JWT format check)
                if (storedToken) {
                    try {
                        const parts = storedToken.split('.');
                        if (parts.length === 3) {
                            // Basic JWT format validation
                            const payload = JSON.parse(atob(parts[1]));
                            const now = Math.floor(Date.now() / 1000);
                            
                            // Check if token is expired
                            if (payload.exp && payload.exp < now) {
                                console.log('Token expired, removing from storage');
                                localStorage.removeItem(TOKEN_STORAGE_KEY);
                                return null;
                            }
                            
                            return storedToken;
                        }
                    } catch (e) {
                        console.log('Invalid token format, removing from storage');
                        localStorage.removeItem(TOKEN_STORAGE_KEY);
                        return null;
                    }
                }
                
                return storedToken || '';
            };

            window.configureToken = function () {
                showLoginModal();
            };

            function showLoginModal() {
                // Remove any existing modal
                const existingModal = document.getElementById('login-modal');
                if (existingModal) existingModal.remove();
                
                const modal = document.createElement('div');
                modal.id = 'login-modal';
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.innerHTML = `
                    <div class="modal-content" style="text-align: center; max-width: 400px;">
                        <div style="margin-bottom: 20px;">
                            <i class="fas fa-shield-alt" style="font-size: 3rem; color: #3b82f6; margin-bottom: 10px;"></i>
                            <h2 style="color: #e2e8f0; margin: 0;">üîê Admin Login</h2>
                            <p style="color: #94a3b8; margin: 10px 0;">Please authenticate to access the admin panel</p>
                        </div>
                        <form id="login-form">
                            <div class="form-group">
                                <label for="admin-username">Username:</label>
                                <input type="text" id="admin-username" required placeholder="Enter admin username" autocomplete="username">
                            </div>
                            <div class="form-group">
                                <label for="admin-password">Password:</label>
                                <input type="password" id="admin-password" required placeholder="Enter admin password" autocomplete="current-password">
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                <i class="fas fa-sign-in-alt"></i> Login
                            </button>
                        </form>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Focus on username field
                setTimeout(() => {
                    document.getElementById('admin-username').focus();
                }, 100);
                
                // Handle form submission
                document.getElementById('login-form').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const username = document.getElementById('admin-username').value;
                    const password = document.getElementById('admin-password').value;
                    
                    try {
                        const response = await fetch('/api/admin/login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ username, password })
                        });
                        
                        const result = await response.json();
                        if (result.success && result.token) {
                            localStorage.setItem(TOKEN_STORAGE_KEY, result.token);
                            showNotification('Login successful!', 'success');
                            modal.remove();
                            // Show dashboard and load data instead of reloading
                            showAllContent();
                            loadRealStats();
                            setInterval(loadRealStats, 30000);
                        } else {
                            showNotification('Invalid credentials', 'error');
                        }
                    } catch (error) {
                        console.error('Login error:', error);
                        showNotification('Login failed', 'error');
                    }
                });
            }

            // Patch fetch to automatically attach Authorization header for /api/admin/*
            const originalFetch = window.fetch.bind(window);
            window.fetch = async function (input, init = {}) {
                try {
                    let url = typeof input === 'string' ? input : (input && input.url) || '';
                    // Only attach for relative admin API calls
                    if (url.startsWith('/api/admin')) {
                        const token = getAdminToken(); // Use the function we defined earlier
                        const headers = new Headers(init.headers || (typeof input !== 'string' ? input.headers : undefined) || {});
                        if (token && !headers.has('Authorization')) {
                            headers.set('Authorization', 'Bearer ' + token);
                        }
                        
                        let response;
                        if (typeof input === 'string') {
                            response = await originalFetch(input, { ...init, headers });
                        } else {
                            response = await originalFetch(new Request(input, { headers }), init);
                        }
                        
                        // Handle authentication errors
                        if (response.status === 401) {
                            console.log('Authentication failed, clearing token and showing login');
                            localStorage.removeItem('adminToken');
                            showLoginModal();
                            throw new Error('Authentication failed');
                        }
                        
                        return response;
                    }
                } catch (error) {
                    if (error.message === 'Authentication failed') {
                        throw error;
                    }
                    // fall through to original fetch for other errors
                }
                return originalFetch(input, init);
            };
        })();
        // --- End Token & Fetch Interceptor ---
        console.log('BirrPay Admin Panel - Enhanced Version Loading...');
        
        let currentData = {
            stats: {
                totalUsers: 0,
                activeUsers: 0,
                paidUsers: 0,
                totalSubscriptions: 0,
                activeSubscriptions: 0,
                pendingSubscriptions: 0,
                totalPayments: 0,
                completedPayments: 0,
                totalRevenue: 0,
                conversionRate: 0,
                avgRevenuePerUser: 0
            },
            users: [],
            subscriptions: [],
            payments: [],
            services: []
        };
        
        let charts = {};
        
        // Notification control - disable auto notifications during navigation
        let showAutoNotifications = false;
        
        // Override showNotification to respect the flag
        const originalShowNotification = window.showNotification;
        window.showNotification = function(message, type) {
            // Only show notifications if it's a manual action or error
            if (showAutoNotifications || type === 'error' || message.includes('Login') || message.includes('Logout')) {
                if (typeof originalShowNotification === 'function') {
                    originalShowNotification(message, type);
                } else {
                    // Fallback notification system
                    console.log(`${type.toUpperCase()}: ${message}`);
                }
            }
        };

        // Manual refresh functions that enable notifications
        function manualRefresh() {
            showAutoNotifications = true;
            loadRealStats().then(() => {
                showAutoNotifications = false;
            });
        }

        function manualRefreshTab(tabName) {
            showAutoNotifications = true;
            showTab(tabName);
            setTimeout(() => {
                showAutoNotifications = false;
            }, 2000);
        }

        async function loadRealStats() {
            console.log('Loading enhanced stats...');
            try {
                const response = await fetch('/api/admin/stats');
                const data = await response.json();
                console.log('Stats received:', data);
                
                if (data.success && data.stats) {
                    currentData.stats = data.stats;
                    
                    // Update main dashboard stats
                    document.getElementById('total-users').textContent = data.stats.totalUsers || 0;
                    document.getElementById('active-subscriptions').textContent = data.stats.activeSubscriptions || 0;
                    document.getElementById('total-revenue').textContent = `ETB ${(data.stats.totalRevenue || 0).toLocaleString()}`;
                    document.getElementById('open-tickets').textContent = data.stats.pendingSupport || 0;
                    
                    // Update sidebar counts with correct data
                    document.getElementById('users-count').textContent = data.stats.totalUsers || 0;
                    document.getElementById('subscriptions-count').textContent = data.stats.totalSubscriptions || 0;
                    document.getElementById('payments-count').textContent = data.stats.totalPayments || 0;
                    document.getElementById('tickets-count').textContent = data.stats.pendingSupport || 0;
                    
                    // Load and update services count
                    loadServicesCount();
                    
                    // Update change indicators
                    updateChangeIndicators(data.stats);
                    
                    // Initialize charts
                    await initCharts();
                    
                    showNotification('Dashboard updated with real data!', 'success');
                    console.log('‚úÖ Enhanced stats updated successfully!');
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                showNotification('Failed to load dashboard data', 'error');
            }
        }
        
        function updateChangeIndicators(stats) {
            // Use real data for percentage changes
            const usersChange = stats.totalUsers || 0;
            const subsChange = stats.activeSubscriptions || 0;
            const revenueChange = stats.totalRevenue || 0;
            
            document.getElementById('users-change').textContent = `+${usersChange} total users`;
            document.getElementById('subs-change').textContent = `+${subsChange} active subs`;
            document.getElementById('revenue-change').textContent = `ETB ${revenueChange} revenue`;
            document.getElementById('tickets-change').textContent = `${stats.pendingSupport || 0} pending`;
        }
        
        async function initCharts() {
            try {
                // Revenue Chart with proper sizing
                const revenueCtx = document.getElementById('revenueChart');
                if (revenueCtx && !charts.revenue) {
                    charts.revenue = new Chart(revenueCtx, {
                        type: 'line',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                            datasets: [{
                                label: 'Revenue (ETB)',
                                data: [0, 0, 0, 0, 0, currentData.stats.totalRevenue || 0],
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: '#3b82f6',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 5
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            aspectRatio: 2,
                            plugins: {
                                legend: { 
                                    labels: { color: '#e2e8f0', font: { size: 12 } },
                                    position: 'top'
                                }
                            },
                            scales: {
                                x: { 
                                    ticks: { color: '#94a3b8', font: { size: 11 } }, 
                                    grid: { color: 'rgba(148, 163, 184, 0.1)' },
                                    border: { color: 'rgba(148, 163, 184, 0.2)' }
                                },
                                y: { 
                                    ticks: { color: '#94a3b8', font: { size: 11 } }, 
                                    grid: { color: 'rgba(148, 163, 184, 0.1)' },
                                    border: { color: 'rgba(148, 163, 184, 0.2)' },
                                    beginAtZero: true
                                }
                            },
                            elements: {
                                point: { radius: 4, hoverRadius: 6 }
                            }
                        }
                    });
                }
                
                // Users Chart with proper sizing
                const usersCtx = document.getElementById('usersChart');
                if (usersCtx && !charts.users) {
                    charts.users = new Chart(usersCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                            datasets: [{
                                label: 'New Users',
                                data: [0, 0, 0, 0, 0, currentData.stats.totalUsers || 0],
                                backgroundColor: 'rgba(139, 92, 246, 0.8)',
                                borderColor: '#8b5cf6',
                                borderWidth: 2,
                                borderRadius: 4,
                                borderSkipped: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            aspectRatio: 2,
                            plugins: {
                                legend: { 
                                    labels: { color: '#e2e8f0', font: { size: 12 } },
                                    position: 'top'
                                }
                            },
                            scales: {
                                x: { 
                                    ticks: { color: '#94a3b8', font: { size: 11 } }, 
                                    grid: { color: 'rgba(148, 163, 184, 0.1)' },
                                    border: { color: 'rgba(148, 163, 184, 0.2)' }
                                },
                                y: { 
                                    ticks: { color: '#94a3b8', font: { size: 11 } }, 
                                    grid: { color: 'rgba(148, 163, 184, 0.1)' },
                                    border: { color: 'rgba(148, 163, 184, 0.2)' },
                                    beginAtZero: true,
                                    max: Math.max(2, currentData.stats.totalUsers || 0)
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error initializing charts:', error);
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName !== 'dashboard') {
                loadTabData(tabName);
            }
        }

        async function loadTabData(tabName) {
            console.log(`Loading enhanced ${tabName} data...`);
            
            // Special handling for services tab
            if (tabName === 'services') {
                loadServices();
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/${tabName}`);
                const data = await response.json();
                console.log(`${tabName} API response:`, data);
                
                if (data.success) {
                    currentData[tabName] = data[tabName] || [];
                    updateTable(tabName, currentData[tabName]);
                    updateTabCounts(tabName, currentData[tabName]);
                    showNotification(`${tabName} data loaded successfully!`, 'success');
                } else {
                    throw new Error(`Failed to load ${tabName} data`);
                }
            } catch (error) {
                console.error(`Error loading ${tabName}:`, error);
                showNotification(`Failed to load ${tabName} data`, 'error');
                showEmptyState(tabName);
            }
        }

        function updateTable(tabName, data) {
            const tableBody = document.querySelector(`#${tabName}-table tbody`);
            if (!tableBody) return;

            tableBody.innerHTML = '';

            if (!data || data.length === 0) {
                showEmptyState(tabName);
                return;
            }
            
            // Add ban/unban status to users data
            if (tabName === 'users') {
                data.forEach(user => {
                    user.isBanned = user.status === 'banned' || user.status === 'suspended';
                });
            }
            
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.style.animationDelay = `${index * 0.1}s`;
                
                if (tabName === 'users') {
                    const isBanned = item.status === 'banned' || item.status === 'suspended';
                    row.innerHTML = `
                        <td>${item.id || 'N/A'}</td>
                        <td>${item.username ? `@${item.username}` : 'N/A'}</td>
                        <td>${item.firstName || ''} ${item.lastName || ''}</td>
                        <td>${item.email || 'N/A'}</td>
                        <td>${item.phone || 'N/A'}</td>
                        <td>
                            <span class="status-badge ${item.status === 'active' ? 'active' : 'inactive'}">
                                ${item.status}${isBanned ? ' (Banned)' : ''}
                            </span>
                        </td>
                        <td>${formatDate(item.createdAt)}</td>
                        <td class="actions">
                            <button class="action-btn view" onclick="viewUser('${item.id}')" title="View User"><i class="fas fa-eye"></i></button>
                            <button class="action-btn edit" onclick="editUser('${item.id}')" title="Edit User"><i class="fas fa-edit"></i></button>
                            ${isBanned ? 
                                `<button class="action-btn unban" onclick="unbanUser('${item.id}')" title="Unban User"><i class="fas fa-user-check"></i></button>` : 
                                `<button class="action-btn ban" onclick="showBanUserModal('${item.id}')" title="Ban User"><i class="fas fa-ban"></i></button>`
                            }
                            <button class="action-btn delete" onclick="deleteUser('${item.id}')" title="Delete User"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                } else if (tabName === 'subscriptions') {
                    const userName = item.userName || item.userFirstName || item.username || 'Unknown User';
                    const userDisplay = item.userFirstName && item.userLastName ? 
                        `${item.userFirstName} ${item.userLastName}` : userName;
                    
                    row.innerHTML = `
                        <td><strong>${userDisplay}</strong><br><small style="color: #64748b;">${item.userEmail || item.userId || ''}</small></td>
                        <td><strong>${item.serviceName || item.serviceId || 'N/A'}</strong></td>
                        <td><span class="status ${item.status === 'active' ? 'active' : item.status === 'pending' ? 'pending' : 'inactive'}">${item.status || 'N/A'}</span></td>
                        <td><strong>ETB ${(item.amount || 0).toLocaleString()}</strong></td>
                        <td>${formatDate(item.createdAt)}</td>
                        <td>
                            <button class="action-btn delete" onclick="cancelSubscription('${item.id}')"><i class="fas fa-times"></i></button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                } else if (tabName === 'payments') {
                    const userName = item.userName || item.userFirstName || item.username || 'Unknown User';
                    const userDisplay = item.userFirstName && item.userLastName ? 
                        `${item.userFirstName} ${item.userLastName}` : userName;
                    
                    row.innerHTML = `
                        <td><strong>${userDisplay}</strong><br><small style="color: #64748b;">${item.userEmail || item.userId || ''}</small></td>
                        <td><strong>ETB ${(item.amount || 0).toLocaleString()}</strong></td>
                        <td><span class="status ${item.status === 'completed' ? 'active' : item.status === 'pending' ? 'pending' : 'inactive'}">${item.status || 'N/A'}</span></td>
                        <td>${item.method || item.paymentMethod || 'Manual Payment'}</td>
                        <td>${formatDate(item.createdAt)}</td>
                        <td>
                            <button class="action-btn edit" onclick="viewPayment('${item.id}')"><i class="fas fa-eye"></i></button>
                            <button class="action-btn delete" onclick="deletePayment('${item.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                } else if (tabName === 'support') {
                    const userName = item.userName || item.userFirstName || item.username || 'Unknown User';
                    const userDisplay = item.userFirstName && item.userLastName ? 
                        `${item.userFirstName} ${item.userLastName}` : userName;
                    
                    row.innerHTML = `
                        <td><strong>${userDisplay}</strong><br><small style="color: #64748b;">${item.userEmail || item.userId || ''}</small></td>
                        <td><strong>${item.subject || 'N/A'}</strong></td>
                        <td><span class="status ${item.status === 'open' ? 'active' : 'inactive'}">${item.status || 'N/A'}</span></td>
                        <td>${item.priority || 'Normal'}</td>
                        <td>${formatDate(item.createdAt)}</td>
                        <td>
                            <button class="action-btn edit" onclick="viewTicket('${item.id}')"><i class="fas fa-eye"></i></button>
                            <button class="action-btn delete" onclick="closeTicket('${item.id}')"><i class="fas fa-check"></i></button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                }
            });
        }

        function showEmptyState(tabName) {
            const tableBody = document.querySelector(`#${tabName}-table tbody`);
            if (!tableBody) return;
            
            const colSpan = tabName === 'users' || tabName === 'subscriptions' ? 7 : 7;
            tableBody.innerHTML = `
                <tr>
                    <td colspan="${colSpan}" class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <div>No ${tabName} found</div>
                        <small>Data will appear here when available</small>
                    </td>
                </tr>
            `;
        }

        function updateTabCounts(tabName, data) {
            const totalElement = document.getElementById(`${tabName}-total`);
            if (totalElement) {
                totalElement.textContent = `${data.length} ${tabName}`;
            }

            // Also update sidebar badge if present (e.g., services-count)
            const sidebarCount = document.getElementById(`${tabName}-count`);
            if (sidebarCount) {
                sidebarCount.textContent = data.length;
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                let date;
                
                // Handle different date formats from Firestore
                if (typeof dateString === 'object') {
                    if (dateString._seconds) {
                        // Firestore timestamp format
                        date = new Date(dateString._seconds * 1000);
                    } else if (dateString.toDate) {
                        // Firestore timestamp object
                        date = dateString.toDate();
                    } else {
                        return 'Invalid Date';
                    }
                } else if (typeof dateString === 'string') {
                    date = new Date(dateString);
                } else if (typeof dateString === 'number') {
                    date = new Date(dateString);
                } else {
                    return 'Invalid Date';
                }
                
                // Check if date is valid
                if (isNaN(date.getTime())) {
                    return 'Invalid Date';
                }
                
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                console.error('Date formatting error:', error);
                return 'Invalid Date';
            }
        }

        // Enhanced filtering and search functions
        function filterUsers(status) {
            const filteredData = status === 'all' ? currentData.users : 
                currentData.users.filter(user => 
                    status === 'active' ? user.isActive : !user.isActive
                );
            updateTable('users', filteredData);
        }

        function filterSubscriptions(status) {
            const filteredData = status === 'all' ? currentData.subscriptions : 
                currentData.subscriptions.filter(sub => sub.status === status);
            updateTable('subscriptions', filteredData);
        }

        function filterByService(service) {
            const filteredData = service === 'all' ? currentData.subscriptions : 
                currentData.subscriptions.filter(sub => sub.serviceId === service);
            updateTable('subscriptions', filteredData);
        }

        function searchUsers(query) {
            if (!query) {
                updateTable('users', currentData.users);
                return;
            }
            
            const filteredData = currentData.users.filter(user =>
                (user.username || '').toLowerCase().includes(query.toLowerCase()) ||
                (user.firstName || '').toLowerCase().includes(query.toLowerCase()) ||
                (user.lastName || '').toLowerCase().includes(query.toLowerCase()) ||
                (user.email || '').toLowerCase().includes(query.toLowerCase())
            );
            updateTable('users', filteredData);
        }

        // Action functions
        function editUser(userId) {
            alert('Edit user: ' + userId);
        }

        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                // Implement delete user logic
                console.log('Delete user:', userId);
            }
        }

        function showBanUserModal(userId) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Ban User</h3>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="banReason">Reason for Ban</label>
                            <textarea id="banReason" rows="4" placeholder="Enter the reason for banning this user..."></textarea>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                            <button class="btn btn-danger" onclick="banUser('${userId}')">Ban User</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function banUser(userId) {
            const banReason = document.getElementById('banReason').value.trim();
            if (!banReason) {
                alert('Please provide a reason for banning this user.');
                return;
            }

            try {
                const response = await fetch(`/api/users/${userId}/suspend`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAdminToken()}`
                    },
                    body: JSON.stringify({ reason: banReason })
                });

                const result = await response.json();
                if (result.ok) {
                    showNotification('User has been banned successfully', 'success');
                    document.querySelector('.modal').remove();
                    loadTabData('users');
                } else {
                    throw new Error(result.error || 'Failed to ban user');
                }
            } catch (error) {
                console.error('Error banning user:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        async function unbanUser(userId) {
            if (!confirm('Are you sure you want to unban this user?')) return;

            try {
                const response = await fetch(`/api/users/${userId}/activate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAdminToken()}`
                    }
                });

                const result = await response.json();
                if (result.ok) {
                    showNotification('User has been unbanned successfully', 'success');
                    loadTabData('users');
                } else {
                    throw new Error(result.error || 'Failed to unban user');
                }
            } catch (error) {
                console.error('Error unbanning user:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        function viewUser(userId) {
            // Implement view user details logic
            alert('View user details: ' + userId);
        }

        function editSubscription(subId) {
            showNotification(`Edit subscription ${subId} - Feature coming soon!`, 'info');
        }

        function cancelSubscription(subId) {
            if (confirm('Are you sure you want to cancel this subscription?')) {
                showNotification(`Cancel subscription ${subId} - Feature coming soon!`, 'info');
            }
        }

        function viewPayment(paymentId) {
            showNotification(`View payment ${paymentId} - Feature coming soon!`, 'info');
        }


        }

        // Load services count for sidebar
        async function loadServicesCount() {
            try {
                const response = await fetch('/api/admin/services');
                const data = await response.json();
                
                if (data.success && data.services) {
                    const servicesCount = data.services.length || 0;
                    document.getElementById('services-count').textContent = servicesCount;
                    console.log(`Services count updated: ${servicesCount}`);
                } else {
                    console.warn('Failed to load services count:', data);
                }
            } catch (error) {
                console.error('Error loading services count:', error);
                // Keep the count as 0 if there's an error
                document.getElementById('services-count').textContent = '0';
            }
        }

        async function exportData(type) {
            try {
                showNotification(`Exporting ${type} data...`, 'info');
                
                let data = [];
                let filename = `birrpay_${type}_${new Date().toISOString().split('T')[0]}.csv`;
                
                switch(type) {
                    case 'users':
                        const usersResponse = await fetch('/api/users');
                        if (!usersResponse.ok) {
                            throw new Error(`Failed to fetch users: ${usersResponse.status}`);
                        }
                        const usersData = await usersResponse.json();
                        const users = Array.isArray(usersData) ? usersData : (usersData.users || []);
                        data = users.map(user => ({
                            'User ID': user.id,
                            'Name': user.name || 'N/A',
                            'Username': user.username || 'N/A',
                            'Email': user.email || 'N/A',
                            'Phone': user.phone || 'N/A',
                            'Telegram ID': user.telegramId,
                            'Status': user.status || 'active',
                            'Subscriptions': user.subscriptionCount || 0,
                            'Total Spent': `${user.totalSpent || 0} ETB`,
                            'Joined Date': user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A'
                        }));
                        break;
                        
                    case 'subscriptions':
                        const subsResponse = await fetch('/api/subscriptions');
                        if (!subsResponse.ok) {
                            throw new Error(`Failed to fetch subscriptions: ${subsResponse.status}`);
                        }
                        const subsData = await subsResponse.json();
                        const subscriptions = Array.isArray(subsData) ? subsData : [];
                        data = subscriptions.map(sub => ({
                            'Subscription ID': sub.id,
                            'User': sub.userName || 'N/A',
                            'Service': sub.serviceName,
                            'Plan': sub.plan,
                            'Price': `${sub.price} ETB`,
                            'Status': sub.status,
                            'Start Date': new Date(sub.startDate).toLocaleDateString(),
                            'End Date': new Date(sub.endDate).toLocaleDateString(),
                            'Auto Renew': sub.autoRenew ? 'Yes' : 'No'
                        }));
                        break;
                        
                    case 'payments':
                        const paymentsResponse = await fetch('/api/payments');
                        if (!paymentsResponse.ok) {
                            throw new Error(`Failed to fetch payments: ${paymentsResponse.status}`);
                        }
                        const paymentsData = await paymentsResponse.json();
                        const payments = Array.isArray(paymentsData) ? paymentsData : [];
                        data = payments.map(payment => ({
                            'Payment ID': payment.id,
                            'User': payment.userName || 'N/A',
                            'Amount': `${payment.amount} ETB`,
                            'Service': payment.serviceName,
                            'Status': payment.status,
                            'Payment Method': payment.method || 'N/A',
                            'Date': new Date(payment.createdAt).toLocaleDateString(),
                            'Transaction ID': payment.transactionId || 'N/A'
                        }));
                        break;
                        
                    case 'services':
                        const servicesResponse = await fetch('/api/services/manage');
                        if (!servicesResponse.ok) {
                            throw new Error(`Failed to fetch services: ${servicesResponse.status}`);
                        }
                        const servicesData = await servicesResponse.json();
                        const services = Array.isArray(servicesData) ? servicesData : [];
                        data = services.map(service => ({
                            'Service ID': service.id,
                            'Name': service.name,
                            'Description': service.description || 'N/A',
                            'Status': service.status,
                            'Plans': service.plans ? service.plans.map(p => `${p.duration}mo: ${p.price}ETB`).join('; ') : 'N/A',
                            'Active Subscriptions': service.activeSubscriptions || 0,
                            'Total Revenue': `${service.totalRevenue || 0} ETB`
                        }));
                        break;
                        
                    default:
                        throw new Error('Unknown export type');
                }
                
                // Generate PDF Report
                if (data.length === 0) {
                    showNotification('No data available to export', 'warning');
                    return;
                }
                
                // Create comprehensive PDF report
                await generatePDFReport(type, data, filename);
                
                showNotification(`${type} data exported as PDF successfully!`, 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                showNotification(`Failed to export ${type} data: ${error.message}`, 'error');
            }
        }

        // Comprehensive PDF Report Generation
        async function generatePDFReport(type, data, filename) {
            // Load jsPDF library dynamically
            if (!window.jsPDF) {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                document.head.appendChild(script);
                await new Promise(resolve => script.onload = resolve);
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // PDF styling
            const primaryColor = [59, 130, 246]; // Blue
            const secondaryColor = [100, 116, 139]; // Gray
            const textColor = [15, 23, 42]; // Dark
            
            let yPosition = 20;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 20;
            
            // Helper function to add new page if needed
            function checkPageBreak(neededSpace = 20) {
                if (yPosition + neededSpace > pageHeight - margin) {
                    doc.addPage();
                    yPosition = 20;
                    return true;
                }
                return false;
            }
            
            // Header
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, 210, 30, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('BirrPay Admin Report', 20, 20);
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`${type.charAt(0).toUpperCase() + type.slice(1)} Data Export`, 20, 27);
            
            // Date and summary
            yPosition = 45;
            doc.setTextColor(...textColor);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, yPosition);
            doc.text(`Total Records: ${data.length}`, 120, yPosition);
            
            yPosition += 15;
            
            // Report content based on type
            switch(type) {
                case 'users':
                    await generateUsersReport(doc, data);
                    break;
                case 'subscriptions':
                    await generateSubscriptionsReport(doc, data);
                    break;
                case 'payments':
                    await generatePaymentsReport(doc, data);
                    break;
                case 'services':
                    await generateServicesReport(doc, data);
                    break;
            }
            
            // Footer on each page
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(...secondaryColor);
                doc.text(`BirrPay Admin Panel - Page ${i} of ${totalPages}`, 20, pageHeight - 10);
                doc.text(`Confidential Business Data`, 120, pageHeight - 10);
            }
            
            // Download PDF
            const pdfFilename = filename.replace('.csv', '.pdf');
            doc.save(pdfFilename);
            
            // Helper functions for different report types
            async function generateUsersReport(doc, users) {
                // Title
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...primaryColor);
                doc.text('Users Overview', 20, yPosition);
                yPosition += 10;
                
                // Summary stats
                const activeUsers = users.filter(u => u.status === 'active').length;
                const totalSpent = users.reduce((sum, u) => sum + (parseFloat(u['Total Spent'].replace(' ETB', '')) || 0), 0);
                
                doc.setFontSize(12);
                doc.setTextColor(...textColor);
                doc.text(`Active Users: ${activeUsers}/${users.length}`, 20, yPosition);
                doc.text(`Total Revenue: ${totalSpent} ETB`, 120, yPosition);
                yPosition += 15;
                
                // Users table
                users.forEach((user, index) => {
                    checkPageBreak(25);
                    
                    // User card
                    doc.setFillColor(248, 250, 252);
                    doc.rect(20, yPosition - 5, 170, 20, 'F');
                    
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${user.Name} (@${user.Username})`, 25, yPosition + 2);
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    doc.text(`ID: ${user['User ID']} | Telegram: ${user['Telegram ID']}`, 25, yPosition + 7);
                    doc.text(`Phone: ${user.Phone} | Email: ${user.Email}`, 25, yPosition + 12);
                    doc.text(`Subscriptions: ${user.Subscriptions} | Spent: ${user['Total Spent']} | Joined: ${user['Joined Date']}`, 25, yPosition + 17);
                    
                    yPosition += 25;
                });
            }
            
            async function generateSubscriptionsReport(doc, subscriptions) {
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...primaryColor);
                doc.text('Subscriptions Overview', 20, yPosition);
                yPosition += 10;
                
                // Summary
                const activeSubscriptions = subscriptions.filter(s => s.Status === 'active').length;
                const totalRevenue = subscriptions.reduce((sum, s) => sum + (parseFloat(s.Price.replace(' ETB', '')) || 0), 0);
                
                doc.setFontSize(12);
                doc.setTextColor(...textColor);
                doc.text(`Active: ${activeSubscriptions}/${subscriptions.length}`, 20, yPosition);
                doc.text(`Total Value: ${totalRevenue} ETB`, 120, yPosition);
                yPosition += 15;
                
                subscriptions.forEach((sub, index) => {
                    checkPageBreak(20);
                    
                    doc.setFillColor(248, 250, 252);
                    doc.rect(20, yPosition - 5, 170, 18, 'F');
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${sub.Service} - ${sub.Plan}`, 25, yPosition + 2);
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    doc.text(`User: ${sub.User} | Price: ${sub.Price} | Status: ${sub.Status}`, 25, yPosition + 7);
                    doc.text(`Period: ${sub['Start Date']} to ${sub['End Date']} | Auto-Renew: ${sub['Auto Renew']}`, 25, yPosition + 12);
                    
                    yPosition += 23;
                });
            }
            
            async function generatePaymentsReport(doc, payments) {
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...primaryColor);
                doc.text('Payments Overview', 20, yPosition);
                yPosition += 10;
                
                const totalAmount = payments.reduce((sum, p) => sum + (parseFloat(p.Amount.replace(' ETB', '')) || 0), 0);
                const completedPayments = payments.filter(p => p.Status === 'completed').length;
                
                doc.setFontSize(12);
                doc.setTextColor(...textColor);
                doc.text(`Completed: ${completedPayments}/${payments.length}`, 20, yPosition);
                doc.text(`Total Amount: ${totalAmount} ETB`, 120, yPosition);
                yPosition += 15;
                
                payments.forEach((payment, index) => {
                    checkPageBreak(18);
                    
                    doc.setFillColor(248, 250, 252);
                    doc.rect(20, yPosition - 5, 170, 16, 'F');
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${payment.Amount} - ${payment.Service}`, 25, yPosition + 2);
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    doc.text(`User: ${payment.User} | Method: ${payment['Payment Method']} | Status: ${payment.Status}`, 25, yPosition + 7);
                    doc.text(`Date: ${payment.Date} | Transaction: ${payment['Transaction ID']}`, 25, yPosition + 11);
                    
                    yPosition += 21;
                });
            }
            
            async function generateServicesReport(doc, services) {
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...primaryColor);
                doc.text('Services Overview', 20, yPosition);
                yPosition += 10;
                
                const activeServices = services.filter(s => s.Status === 'active').length;
                const totalRevenue = services.reduce((sum, s) => sum + (parseFloat(s['Total Revenue'].replace(' ETB', '')) || 0), 0);
                
                doc.setFontSize(12);
                doc.setTextColor(...textColor);
                doc.text(`Active Services: ${activeServices}/${services.length}`, 20, yPosition);
                doc.text(`Total Revenue: ${totalRevenue} ETB`, 120, yPosition);
                yPosition += 15;
                
                services.forEach((service, index) => {
                    checkPageBreak(25);
                    
                    doc.setFillColor(248, 250, 252);
                    doc.rect(20, yPosition - 5, 170, 22, 'F');
                    
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${service.Name}`, 25, yPosition + 2);
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    doc.text(`Description: ${service.Description}`, 25, yPosition + 7);
                    doc.text(`Plans: ${service.Plans}`, 25, yPosition + 11);
                    doc.text(`Active Subs: ${service['Active Subscriptions']} | Revenue: ${service['Total Revenue']} | Status: ${service.Status}`, 25, yPosition + 15);
                    
                    yPosition += 27;
                });
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, checking authentication...');
            
            // Check if user is authenticated
            const token = getAdminToken();
            if (!token) {
                console.log('No authentication token found, showing login modal');
                // Hide main content and show login modal
                const container = document.querySelector('.container');
                if (container) {
                    container.style.display = 'none';
                }
                hideLoadingScreen();
                showLoginModal();
            } else {
                console.log('Authentication token found, loading dashboard');
                // Show main content and load data
                const container = document.querySelector('.container');
                if (container) {
                    container.style.display = 'flex';
                }
                hideLoadingScreen();
                // Load real stats with authentication
                loadRealStats();
            }
        });

        function checkAuthenticationStatus() {
            const token = getAdminToken();
            if (!token) {
                // No token, hide loading screen and show login modal
                hideLoadingScreen();
                showLoginModal();
            } else {
                // Token exists, verify it's valid
                verifyTokenAndLoadDashboard();
            }
        }

        function getAdminToken() {
            // Check localStorage first, then sessionStorage, then cookies
            return localStorage.getItem('adminToken') || 
                   sessionStorage.getItem('adminToken') || 
                   getCookie('adminToken');
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function showLoginModal() {
            // Hide main content
            const container = document.querySelector('.container');
            if (container) {
                container.style.display = 'none';
            }

            // Create login modal
            const loginModal = document.createElement('div');
            loginModal.id = 'login-modal';
            loginModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            loginModal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
                    padding: 40px;
                    border-radius: 20px;
                    border: 1px solid #334155;
                    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
                    width: 400px;
                    max-width: 90%;
                    text-align: center;
                ">
                    <div style="margin-bottom: 30px;">
                        <i class="fas fa-chart-line" style="font-size: 3rem; color: #3b82f6; margin-bottom: 15px;"></i>
                        <h2 style="color: #e2e8f0; margin: 0 0 10px 0;">BirrPay Admin</h2>
                        <p style="color: #94a3b8; margin: 0;">Please login to continue</p>
                    </div>
                    
                    <form id="login-form" style="text-align: left;">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; color: #e2e8f0; margin-bottom: 8px; font-weight: 600;">Username:</label>
                            <input type="text" id="username" required style="
                                width: 100%;
                                padding: 12px;
                                border: 1px solid #334155;
                                border-radius: 8px;
                                background: rgba(15, 23, 42, 0.8);
                                color: #e2e8f0;
                                box-sizing: border-box;
                            ">
                        </div>
                        
                        <div style="margin-bottom: 30px;">
                            <label style="display: block; color: #e2e8f0; margin-bottom: 8px; font-weight: 600;">Password:</label>
                            <input type="password" id="password" required style="
                                width: 100%;
                                padding: 12px;
                                border: 1px solid #334155;
                                border-radius: 8px;
                                background: rgba(15, 23, 42, 0.8);
                                color: #e2e8f0;
                                box-sizing: border-box;
                            ">
                        </div>
                        
                        <button type="submit" style="
                            width: 100%;
                            padding: 12px;
                            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            <i class="fas fa-sign-in-alt" style="margin-right: 8px;"></i>
                            Login
                        </button>
                    </form>
                    
                    <div id="login-error" style="
                        margin-top: 15px;
                        padding: 10px;
                        background: rgba(239, 68, 68, 0.1);
                        border: 1px solid rgba(239, 68, 68, 0.3);
                        border-radius: 6px;
                        color: #ef4444;
                        font-size: 0.9rem;
                        display: none;
                    "></div>
                </div>
            `;
            
            document.body.appendChild(loginModal);
            
            // Handle login form submission
            document.getElementById('login-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const errorDiv = document.getElementById('login-error');
                
                try {
                    const response = await fetch('/api/admin/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username, password })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success && result.token) {
                        // Store token
                        localStorage.setItem('adminToken', result.token);
                        
                        // Remove login modal
                        loginModal.remove();
                        
                        // Show main content and load dashboard
                        const container = document.querySelector('.container');
                        if (container) {
                            container.style.display = 'flex';
                        }
                        
                        // Load dashboard data
                        loadRealStats();
                        showNotification('Login successful!', 'success');
                    } else {
                        errorDiv.textContent = result.message || 'Invalid credentials';
                        errorDiv.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    errorDiv.textContent = 'Login failed. Please try again.';
                    errorDiv.style.display = 'block';
                }
            });
        }

        function verifyTokenAndLoadDashboard() {
            // For now, just show the dashboard and load data
            // In a real implementation, you'd verify the token with the server
            const container = document.querySelector('.container');
            if (container) {
                container.style.display = 'flex';
            }
            hideLoadingScreen();
            loadRealStats();
        }

        function hideAllContent() {
            // Hide the entire dashboard content
            const container = document.querySelector('.container');
            if (container) {
                container.style.display = 'none';
            }
            // Show loading screen
            showLoadingScreen();
        }

        function showLoadingScreen() {
            const loadingScreen = document.createElement('div');
            loadingScreen.id = 'loading-screen';
            loadingScreen.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                flex-direction: column;
                z-index: 9999;
            `;
            loadingScreen.innerHTML = `
                <div style="text-align: center;">
                    <i class="fas fa-chart-line" style="font-size: 4rem; color: #3b82f6; margin-bottom: 20px; animation: pulse 2s infinite;"></i>
                    <h1 style="color: #e2e8f0; margin: 0 0 10px 0; font-size: 2rem;">BirrPay</h1>
                    <p style="color: #94a3b8; margin: 0;">Admin Dashboard</p>
                    <div style="margin-top: 30px;">
                        <div class="spinner" style="margin: 0 auto;"></div>
                        <p style="color: #64748b; margin-top: 15px;">Checking authentication...</p>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingScreen);
        }

        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.remove();
            }
        }

        function showAllContent() {
            // Hide loading screen and show the dashboard content
            hideLoadingScreen();
            const container = document.querySelector('.container');
            if (container) {
                container.style.display = 'flex';
            }
        }

        async function verifyTokenAndLoadDashboard() {
            try {
                // Just show the dashboard - token will be validated by API calls as needed
                showAllContent();
                loadRealStats();
                setInterval(loadRealStats, 30000);
            } catch (error) {
                console.error('Error loading dashboard:', error);
                hideLoadingScreen();
                showLoginModal();
            }
        }

        // Services tab functions
        async function loadServices() {
            try {
                const response = await fetch('/api/admin/services');
                const data = await response.json();
                
                if (data.success && data.services) {
                    currentData.services = data.services;
                    updateServicesTable(data.services);
                    updateTabCounts('services', data.services);
                }
            } catch (error) {
                console.error('Error loading services:', error);
                showNotification('Failed to load services data', 'error');
            }
        }

        function updateServicesTable(services) {
            const container = document.getElementById('services-content');
            if (!container) return;

            if (!services || services.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-cogs fa-3x"></i>
                        <h3>No Services Found</h3>
                        <p>There are currently no services in the system.</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="header">
                    <h2><i class="fas fa-cogs"></i> Service Management</h2>
                    <div class="header-actions">
                        <span id="services-total" class="nav-count" style="margin-right: 12px;">${services.length} services</span>
                        <button class="btn btn-primary" onclick="showAddServiceModal()">
                            <i class="fas fa-plus"></i> Add Service
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Service</th>
                                <th>Plans & Pricing</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            services.forEach(service => {
                // Handle both old and new service structure
                const plans = service.plans || [
                    { duration: 1, price: service.price || 0, billingCycle: 'monthly' },
                    { duration: 3, price: (service.price || 0) * 2.7, billingCycle: 'quarterly' },
                    { duration: 6, price: (service.price || 0) * 5, billingCycle: 'semi-annual' },
                    { duration: 12, price: (service.price || 0) * 9, billingCycle: 'annual' }
                ];
                
                // Create detailed plan display with pricing tiers
                const planDisplay = `
                    <div class="plan-pricing">
                        ${plans.map(p => `
                            <div class="plan-item">
                                <span class="plan-duration">${p.duration}mo</span>
                                <span class="plan-price">${Math.round(p.price)} ETB</span>
                                <span class="plan-type">${p.billingCycle || 'monthly'}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                html += `
                    <tr>
                        <td>
                            <div class="service-info">
                                <strong>${service.name}</strong>
                                <div class="service-meta">
                                    <small>${service.description || 'Premium streaming service'}</small>
                                </div>
                            </div>
                        </td>
                        <td>${planDisplay}</td>
                        <td><span class="status-badge ${service.status || 'active'}">${service.status || 'active'}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary" onclick="editService('${service.id || service.serviceID}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-secondary" onclick="deleteService('${service.id || service.serviceID}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        function showAddServiceModal() {
            // Create modal for adding service
            const modal = document.createElement('div');
            modal.id = 'service-modal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="closeServiceModal()">&times;</span>
                    <h2>Add New Service</h2>
                    <form id="service-form">
                        <div class="form-group">
                            <label for="service-name">Service Name:</label>
                            <input type="text" id="service-name" required>
                        </div>
                        <div class="form-group">
                            <label for="service-description">Description:</label>
                            <textarea id="service-description" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Subscription Plans:</label>
                            <div id="plans-container">
                                <div class="plan-row">
                                    <input type="number" placeholder="Duration (months)" min="1" class="plan-duration" value="1" required>
                                    <input type="number" placeholder="Price (ETB)" min="1" class="plan-price" required>
                                    <select class="plan-billing">
                                        <option value="monthly">Monthly</option>
                                        <option value="yearly">Yearly</option>
                                    </select>
                                    <button type="button" onclick="removePlan(this)" class="btn-remove-plan">√ó</button>
                                </div>
                            </div>
                            <button type="button" onclick="addPlan()" class="btn btn-secondary">+ Add Plan</button>
                        </div>
                        <div class="form-group">
                            <label for="service-status">Status:</label>
                            <select id="service-status">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Service</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Handle form submission
            document.getElementById('service-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const name = document.getElementById('service-name').value;
                const description = document.getElementById('service-description').value;
                const status = document.getElementById('service-status').value;
                
                // Collect plans data
                const planRows = document.querySelectorAll('.plan-row');
                const plans = [];
                planRows.forEach(row => {
                    const duration = parseInt(row.querySelector('.plan-duration').value);
                    const price = parseInt(row.querySelector('.plan-price').value);
                    const billingCycle = row.querySelector('.plan-billing').value;
                    if (duration && price) {
                        plans.push({ duration, price, billingCycle });
                    }
                });
                
                if (plans.length === 0) {
                    showNotification('Please add at least one subscription plan', 'error');
                    return;
                }
                
                try {
                    const response = await fetch('/api/admin/services', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name, description, plans, status })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        showNotification('Service added successfully!', 'success');
                        closeServiceModal();
                        loadServices();
                    } else {
                        showNotification('Failed to add service: ' + result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error adding service:', error);
                    showNotification('Failed to add service', 'error');
                }
            });
        }

        function showAddServiceModal() {
            // Create modal for adding new service with multi-plan pricing
            const modal = document.createElement('div');
            modal.id = 'service-modal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="closeServiceModal()">&times;</span>
                    <h2><i class="fas fa-plus"></i> Add New Service</h2>
                    <form id="service-form">
                        <div class="form-group">
                            <label for="service-name">Service Name:</label>
                            <input type="text" id="service-name" placeholder="e.g., Netflix Premium" required>
                        </div>
                        <div class="form-group">
                            <label for="service-description">Description:</label>
                            <textarea id="service-description" rows="3" placeholder="Premium streaming service with HD content"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Subscription Plans & Pricing:</label>
                            <div id="plans-container">
                                <div class="plan-row" data-plan-index="0">
                                    <div class="plan-inputs">
                                        <div class="input-group">
                                            <label>Duration (months):</label>
                                            <select class="plan-duration">
                                                <option value="1" selected>1 Month</option>
                                                <option value="3">3 Months</option>
                                                <option value="6">6 Months</option>
                                                <option value="12">12 Months</option>
                                            </select>
                                        </div>
                                        <div class="input-group">
                                            <label>Price (ETB):</label>
                                            <input type="number" class="plan-price" min="1" placeholder="300" required>
                                        </div>
                                        <div class="input-group">
                                            <label>Billing Cycle:</label>
                                            <select class="plan-billing">
                                                <option value="monthly" selected>Monthly</option>
                                                <option value="quarterly">Quarterly</option>
                                                <option value="semi-annual">Semi-Annual</option>
                                                <option value="annual">Annual</option>
                                            </select>
                                        </div>
                                        <button type="button" class="btn btn-secondary remove-plan" onclick="removePlan(this)" disabled>
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="plan-row" data-plan-index="1">
                                    <div class="plan-inputs">
                                        <div class="input-group">
                                            <label>Duration (months):</label>
                                            <select class="plan-duration">
                                                <option value="1">1 Month</option>
                                                <option value="3" selected>3 Months</option>
                                                <option value="6">6 Months</option>
                                                <option value="12">12 Months</option>
                                            </select>
                                        </div>
                                        <div class="input-group">
                                            <label>Price (ETB):</label>
                                            <input type="number" class="plan-price" min="1" placeholder="810" required>
                                        </div>
                                        <div class="input-group">
                                            <label>Billing Cycle:</label>
                                            <select class="plan-billing">
                                                <option value="monthly">Monthly</option>
                                                <option value="quarterly" selected>Quarterly</option>
                                                <option value="semi-annual">Semi-Annual</option>
                                                <option value="annual">Annual</option>
                                            </select>
                                        </div>
                                        <button type="button" class="btn btn-secondary remove-plan" onclick="removePlan(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="plan-row" data-plan-index="2">
                                    <div class="plan-inputs">
                                        <div class="input-group">
                                            <label>Duration (months):</label>
                                            <select class="plan-duration">
                                                <option value="1">1 Month</option>
                                                <option value="3">3 Months</option>
                                                <option value="6" selected>6 Months</option>
                                                <option value="12">12 Months</option>
                                            </select>
                                        </div>
                                        <div class="input-group">
                                            <label>Price (ETB):</label>
                                            <input type="number" class="plan-price" min="1" placeholder="1500" required>
                                        </div>
                                        <div class="input-group">
                                            <label>Billing Cycle:</label>
                                            <select class="plan-billing">
                                                <option value="monthly">Monthly</option>
                                                <option value="quarterly">Quarterly</option>
                                                <option value="semi-annual" selected>Semi-Annual</option>
                                                <option value="annual">Annual</option>
                                            </select>
                                        </div>
                                        <button type="button" class="btn btn-secondary remove-plan" onclick="removePlan(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="plan-row" data-plan-index="3">
                                    <div class="plan-inputs">
                                        <div class="input-group">
                                            <label>Duration (months):</label>
                                            <select class="plan-duration">
                                                <option value="1">1 Month</option>
                                                <option value="3">3 Months</option>
                                                <option value="6">6 Months</option>
                                                <option value="12" selected>12 Months</option>
                                            </select>
                                        </div>
                                        <div class="input-group">
                                            <label>Price (ETB):</label>
                                            <input type="number" class="plan-price" min="1" placeholder="2700" required>
                                        </div>
                                        <div class="input-group">
                                            <label>Billing Cycle:</label>
                                            <select class="plan-billing">
                                                <option value="monthly">Monthly</option>
                                                <option value="quarterly">Quarterly</option>
                                                <option value="semi-annual">Semi-Annual</option>
                                                <option value="annual" selected>Annual</option>
                                            </select>
                                        </div>
                                        <button type="button" class="btn btn-secondary remove-plan" onclick="removePlan(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="addPlan()">
                                <i class="fas fa-plus"></i> Add Plan
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label for="service-status">Status:</label>
                            <select id="service-status">
                                <option value="active" selected>Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Service</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Handle form submission
            document.getElementById('service-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const name = document.getElementById('service-name').value;
                const description = document.getElementById('service-description').value;
                const status = document.getElementById('service-status').value;
                
                // Collect plans data
                const planRows = document.querySelectorAll('.plan-row');
                const plans = [];
                planRows.forEach(row => {
                    const duration = parseInt(row.querySelector('.plan-duration').value);
                    const price = parseInt(row.querySelector('.plan-price').value);
                    const billingCycle = row.querySelector('.plan-billing').value;
                    if (duration && price) {
                        plans.push({ duration, price, billingCycle });
                    }
                });
                
                if (plans.length === 0) {
                    showNotification('Please add at least one subscription plan', 'error');
                    return;
                }
                
                try {
                    const response = await fetch('/api/admin/services', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name, description, plans, status })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        showNotification('Service added successfully!', 'success');
                        closeServiceModal();
                        loadServices();
                    } else {
                        showNotification('Failed to add service: ' + result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error adding service:', error);
                    showNotification('Failed to add service', 'error');
                }
            });
        }

        function closeServiceModal() {
            const modal = document.getElementById('service-modal');
            if (modal) modal.remove();
        }

        function editService(serviceId) {
            // Find service data
            const service = currentData.services.find(s => s.id === serviceId || s.serviceID === serviceId);
            if (!service) return;

            // Prepare existing plans or create default structure
            const existingPlans = service.plans || [
                { duration: 1, price: service.price || 0, billingCycle: 'monthly' },
                { duration: 3, price: (service.price || 0) * 2.7, billingCycle: 'quarterly' },
                { duration: 6, price: (service.price || 0) * 5, billingCycle: 'semi-annual' },
                { duration: 12, price: (service.price || 0) * 9, billingCycle: 'annual' }
            ];

            // Create modal for editing service
            const modal = document.createElement('div');
            modal.id = 'service-modal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="closeServiceModal()">&times;</span>
                    <h2><i class="fas fa-edit"></i> Edit Service: ${service.name}</h2>
                    <form id="service-form">
                        <div class="form-group">
                            <label for="service-name">Service Name:</label>
                            <input type="text" id="service-name" value="${service.name}" required>
                        </div>
                        <div class="form-group">
                            <label for="service-description">Description:</label>
                            <textarea id="service-description" rows="3">${service.description || 'Premium streaming service'}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Subscription Plans & Pricing:</label>
                            <div id="plans-container">
                                ${existingPlans.map((plan, index) => `
                                    <div class="plan-row" data-plan-index="${index}">
                                        <div class="plan-inputs">
                                            <div class="input-group">
                                                <label>Duration (months):</label>
                                                <select class="plan-duration">
                                                    <option value="1" ${plan.duration === 1 ? 'selected' : ''}>1 Month</option>
                                                    <option value="3" ${plan.duration === 3 ? 'selected' : ''}>3 Months</option>
                                                    <option value="6" ${plan.duration === 6 ? 'selected' : ''}>6 Months</option>
                                                    <option value="12" ${plan.duration === 12 ? 'selected' : ''}>12 Months</option>
                                                </select>
                                            </div>
                                            <div class="input-group">
                                                <label>Price (ETB):</label>
                                                <input type="number" class="plan-price" min="1" value="${Math.round(plan.price)}" required>
                                            </div>
                                            <div class="input-group">
                                                <label>Billing Cycle:</label>
                                                <select class="plan-billing">
                                                    <option value="monthly" ${plan.billingCycle === 'monthly' ? 'selected' : ''}>Monthly</option>
                                                    <option value="quarterly" ${plan.billingCycle === 'quarterly' ? 'selected' : ''}>Quarterly</option>
                                                    <option value="semi-annual" ${plan.billingCycle === 'semi-annual' ? 'selected' : ''}>Semi-Annual</option>
                                                    <option value="annual" ${plan.billingCycle === 'annual' ? 'selected' : ''}>Annual</option>
                                                </select>
                                            </div>
                                            <button type="button" class="btn btn-secondary remove-plan" onclick="removePlan(this)" ${existingPlans.length <= 1 ? 'disabled' : ''}>
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="addPlan()">
                                <i class="fas fa-plus"></i> Add Plan
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label for="service-status">Status:</label>
                            <select id="service-status">
                                <option value="active" ${service.status === 'active' ? 'selected' : ''}>Active</option>
                                <option value="inactive" ${service.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Service</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Handle form submission
            document.getElementById('service-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const name = document.getElementById('service-name').value;
                const description = document.getElementById('service-description').value;
                const status = document.getElementById('service-status').value;
                
                // Collect plans data
                const planRows = document.querySelectorAll('.plan-row');
                const plans = [];
                planRows.forEach(row => {
                    const duration = parseInt(row.querySelector('.plan-duration').value);
                    const price = parseInt(row.querySelector('.plan-price').value);
                    const billingCycle = row.querySelector('.plan-billing').value;
                    if (duration && price) {
                        plans.push({ duration, price, billingCycle });
                    }
                });
                
                if (plans.length === 0) {
                    showNotification('Please add at least one subscription plan', 'error');
                    return;
                }
                
                try {
                    const response = await fetch(`/api/admin/services/${serviceId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name, description, plans, status })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        showNotification('Service updated successfully!', 'success');
                        closeServiceModal();
                        loadServices();
                    } else {
                        showNotification('Failed to update service: ' + result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error updating service:', error);
                    showNotification('Failed to update service', 'error');
                }
            });
        }

        function deleteService(serviceId) {
            if (confirm('Are you sure you want to delete this service?')) {
                fetch(`/api/admin/services/${serviceId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showNotification('Service deleted successfully!', 'success');
                        loadServices();
                    } else {
                        showNotification('Failed to delete service: ' + result.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error deleting service:', error);
                    showNotification('Failed to delete service', 'error');
                });
            }
        }

        // Helper functions for plan management
        window.addPlan = function() {
            const container = document.getElementById('plans-container');
            const newPlan = document.createElement('div');
            newPlan.className = 'plan-row';
            newPlan.innerHTML = `
                <input type="number" placeholder="Duration (months)" min="1" class="plan-duration" required>
                <input type="number" placeholder="Price (ETB)" min="1" class="plan-price" required>
                <select class="plan-billing">
                    <option value="monthly">Monthly</option>
                    <option value="yearly">Yearly</option>
                </select>
                <button type="button" onclick="removePlan(this)" class="btn-remove-plan">√ó</button>
            `;
            container.appendChild(newPlan);
        };

        window.removePlan = function(button) {
            const planRow = button.closest('.plan-row');
            const container = document.getElementById('plans-container');
            if (container.children.length > 1) {
                planRow.remove();
            } else {
                showNotification('At least one plan is required', 'error');
            }
        };

        // Add CSS for modal and form
        const style = document.createElement('style');
        style.textContent = `
            .modal { display: block; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
            .modal-content { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); margin: 5% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; border: 1px solid rgba(59, 130, 246, 0.2); }
            .modal-content h2 { color: #e2e8f0; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; }
            .close { color: #94a3b8; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
            .close:hover { color: #e2e8f0; }
            .form-group { margin-bottom: 20px; }
            .form-group label { display: block; margin-bottom: 8px; color: #e2e8f0; font-weight: 500; }
            .form-group input, .form-group select, .form-group textarea { 
                width: 100%; padding: 12px; border: 1px solid #334155; border-radius: 8px; 
                background: rgba(15, 23, 42, 0.8); color: #e2e8f0; font-size: 14px; 
            }
            .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
                outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); 
            }
            .plan-row { 
                background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(51, 65, 85, 0.5); 
                border-radius: 10px; padding: 20px; margin-bottom: 15px; 
            }
            .plan-inputs { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end; }
            .input-group { display: flex; flex-direction: column; }
            .input-group label { margin-bottom: 5px; font-size: 0.9rem; color: #94a3b8; }
            .input-group input, .input-group select { 
                padding: 8px 12px; border: 1px solid #475569; border-radius: 6px; 
                background: rgba(15, 23, 42, 0.9); color: #e2e8f0; 
            }
            .remove-plan { padding: 8px 12px; height: fit-content; }
            .remove-plan:disabled { opacity: 0.5; cursor: not-allowed; }
            @media (max-width: 768px) {
                .plan-inputs { grid-template-columns: 1fr; }
                .modal-content { margin: 2% auto; width: 95%; padding: 20px; }
            }
            .modal-content { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); margin: 10% auto; padding: 30px; border: 1px solid #334155; border-radius: 15px; width: 600px; max-width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-height: 80vh; overflow-y: auto; }
            .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
            .close:hover { color: white; }
            .form-group { margin-bottom: 20px; }
            .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
            .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #334155; border-radius: 8px; background: rgba(15, 23, 42, 0.8); color: #e2e8f0; }
            .plan-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
            .plan-row input, .plan-row select { flex: 1; }
            .btn-remove-plan { background: #ef4444; color: white; border: none; border-radius: 4px; width: 30px; height: 30px; cursor: pointer; }
            .btn-remove-plan:hover { background: #dc2626; }
            .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
            .status-badge.active { background: rgba(16, 185, 129, 0.2); color: #10b981; }
            .status-badge.inactive { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        `;
        document.head.appendChild(style);

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear any stored authentication tokens
                localStorage.removeItem('adminToken');
                sessionStorage.removeItem('adminToken');
                
                // Clear any cookies
                document.cookie = 'adminToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                
                // Show logout message
                showNotification('Logged out successfully!', 'success');
                
                // Hide main content immediately
                const container = document.querySelector('.container');
                if (container) {
                    container.style.display = 'none';
                }
                
                // Show login modal instantly
                showLoginModal();
            }
        }
    </script>
</body>
</html>
